var Animation = function () {

    /**
     * 随机获取转入场动画 [需要页面引入 animate.css]
     * @param flag
     * @returns {string|string[]}
     */
    this.getAnimateIn = function (flag) {//获取转入场动画 键, 传入参数则返回数据, 不传则随机一个键
        var amIn = ["bounceIn", "bounceInDown", "bounceInLeft", "bounceInRight", "bounceInUp", "fadeIn", "fadeInDown", "fadeInDownBig", "fadeInLeft", "fadeInLeftBig", "fadeInRight", "fadeInRightBig", "fadeInUp", "fadeInUpBig", "flipInX", "flipInY", "lightSpeedIn", "rotateIn", "rotateInDownLeft", "rotateInDownRight", "rotateInUpLeft", "rotateInUpRight", "slideInDown", "slideInLeft", "slideInRight", "rollIn"];
        if (flag) {
            return amIn;
        }
        return amIn[Math.floor(Math.random() * amIn.length)];
    };

    /**
     * 随机获取转出场动画 [需要页面引入 animate.css]
     * @param flag
     * @returns {string|string[]}
     */
    this.getAnimateOut = function (flag) {//获取转出场动画 键, 传入参数则返回数据, 不传则随机一个键
        var amOut = ["bounceOut", "bounceOutDown", "bounceOutLeft", "bounceOutRight", "bounceOutUp", "fadeOut", "fadeOutDown", "fadeOutDownBig", "fadeOutLeft", "fadeOutLeftBig", "fadeOutRight", "fadeOutRightBig", "fadeOutUp", "fadeOutUpBig", "flipOutX", "flipOutY", "lightSpeedOut", "rotateOut", "rotateOutDownLeft", "rotateOutDownRight", "rotateOutUpLeft", "rotateOutUpRight", "slideOutUp", "slideOutLeft", "slideOutRight", "hinge", "rollOut"];
        if (flag) {
            return amOut;
        }
        return amOut[Math.floor(Math.random() * amOut.length)];
    };

    /**
     * 随机获取转驻场动画 [需要页面引入 animate.css]
     * @param flag
     * @returns {string|string[]}
     */
    this.getAnimateStay = function (flag) {//获取停驻场动画 键, 传入参数则返回数据, 不传则随机一个键
        var amStay = ["bounce", "flash", "pulse", "rubberBand", "shake", "swing", "tada", "wobble", "flip"];
        if (flag) {
            return amStay;
        }
        return amStay[Math.floor(Math.random() * amStay.length)];
    };
};
var animation = new Animation();

/**
 * 通用渲染进程处理库
 *
 * @constructor
 */
var ZXX = function () {

    /**
     * 将iframe 的 data-src 渲染到 src, 配置了 data-nopreload="true" 的除外, 自行手动渲染
     * 该策略是为了防止 Chrome 自行对 iframe 进行缓存.
     */
    this.dealIframeSrc = function () {
        $('iframe[data-src]').each(function () {
            var orignSrc = $(this).attr('src');
            if (!orignSrc || orignSrc === '') {
                var src = $(this).attr('data-src');
                var nopreload = $(this).attr('data-nopreload');
                if (!(nopreload + '' === 'true')) {
                    $(this).attr('src', src);
                }
            }
        });
        return this;
    };

    /**
     * 自动转入场控制 [需要页面引入 animate.css]
     */
    this.animateIn = function () {
        var elemClass = '.' + 'zxx-random-animate-in';
        $(elemClass).css("display", "none");
        $(elemClass).fadeIn(100).addClass('animated ' + animation.getAnimateIn());
        return this;
    };

    /**
     * 自动转出场控制 [需要页面引入 animate.css]
     */
    this.animateOut = function () {
        var elemClass = '.' + 'zxx-random-animate-out';
        $(elemClass).addClass('animated ' + animation.getAnimateOut()).fadeOut(500);
        return this;
    };

    /**
     * 自动转出场控制 [需要页面引入 animate.css]
     */
    this.animateStay = function () {
        var elemClass = '.' + 'zxx-random-animate-stay';
        $(elemClass).addClass('animated ' + animation.getAnimateStay());
        return this;
    };

    this.obj2formatstring = function (o, c) {//暴力拟格式化输出对象
        c = c ? c : 0;
        var sp = "";
        for (var i = 0; i < c; i++) {
            var spp = "  ";
            sp += spp;
        }
        var r = [];
        if (typeof o == "string") {
            return "\"" + o.replace(/([\'\"\\])/g, "\\$1").replace(/(\n)/g, "\\n").replace(/(\r)/g, "\\r").replace(/(\t)/g, "\\t") + "\"";
        }
        if (typeof o == "object") {
            if (!o.sort) {
                for (var i in o) {
                    r.push(sp + "  " + i + ":" + father.obj2formatstring(o[i], 2));
                }
                if (!!document.all && !/^\n?function\s*toString\(\)\s*\{\n?\s*\[native code\]\n?\s*\}\n?\s*$/.test(o.toString)) {
                    r.push("toString:" + o.toString.toString());
                }
                r = "{\n" + r.join(",\n") + "\n}";
            } else {
                for (var i = 0; i < o.length; i++) {
                    r.push(sp + "  " + father.obj2formatstring(o[i], 2))
                }
                r = "[\n" + r.join(",\n") + "\n]";
            }
            return r;
        }
        return o.toString();
    };

    /**
     * json对象转换成字符串
     * @param o
     * @returns {string}
     */
    this.converterJSONString = function (o) {//json对象转串
        var s = JSON.stringify(eval('(' + o + ')'), function (key, val) {
            if (typeof val === 'function') {
                return val + '';
            }
            return val;
        }, 2);
        return s.replace(/\\n/g, "");
    };

    /**
     * json串转对象, 第二个参数决定直接回传对象, 而不是格式化输出为字符串
     *
     * @param s
     * @param getObj
     * @returns {any}
     */
    this.converterJSONObject = function (s, getObj) {
        var o = JSON.parse(s, function (k, v) {
            if (v.indexOf && v.indexOf('function') > -1) {
                return eval("(function(){return " + v + " })()")
            }
            return v;
        });
        if (getObj) {
            return o.replace(/\\n/g, "");
        } else {
            return this.obj2formatstring(o).replace(/\\n/g, "");
        }
    };

    /**
     * 转义 HTML 脚本
     *
     * @param a
     * @returns {string}
     */
    this.escapeHTML = function (a) {
        a = "" + a;
        return a.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&apos;");
    };

    /**
     * @function unescapeHTML 还原 HTML 转义脚本 < > & " '
     * @param a -
     *            字符串
     */
    this.unescapeHTML = function (a) {
        a = "" + a;
        return a.replace(/&lt;/g, "<").replace(/&gt;/g, ">").replace(/&amp;/g, "&").replace(/&quot;/g, '"').replace(/&apos;/g, "'");
    };

    /**
     * 去除字符串中的Html标签
     * @param a
     * @returns {string}
     */
    this.removeHtml = function (a) {
        a = "" + a;
        a = a.replace(/<br>/g, '\r\n').replace(/<br\/>/g, '\r\n').replace(/<\/br>/g, '\r\n');
        return a.replace(/<[^>]+>/g, "");
    };

    /**
     * 调起文件系统选择框
     *
     * @param multiple 是否支持多选
     * @param dir 是否只能进行文件夹选择
     * @param accept 限定类型 例如:  accept="image/gif, image/jpeg"
     * @param callback 回调
     */
    this.selectFile = function (multiple, dir, accept, callback) {
        // 创建input标签
        var inputObj = document.createElement('input')
        // 设置属性
        inputObj.setAttribute('id', '_zxx-select-file-ef');
        inputObj.setAttribute('type', 'file');
        inputObj.setAttribute("style", 'visibility:hidden');
        accept ? inputObj.setAttribute('accept', accept) : '';
        multiple ? inputObj.setAttribute('multiple', 'multiple') : '';
        if (dir) { // 如果要选择目录路径，则添加以下两个属性
            inputObj.setAttribute('webkitdirectory', "");
            inputObj.setAttribute('directory', "");
        }
        // 添加到DOM中
        document.body.appendChild(inputObj);
        // 添加事件监听器
        inputObj.addEventListener("change", function () {
            var inputObj = document.getElementById("_zxx-select-file-ef");
            var files = inputObj.files;
            if (typeof callback === 'function') {
                callback(files);
            }
            // 移除事件监听器
            inputObj.removeEventListener("change", function () {
            });
            // 从DOM中移除input
            document.body.removeChild(inputObj);
        });
        // 模拟点击
        inputObj.click();
    }

    /**
     * 剪贴板逻辑
     */
    this.writeClipboard = function () {
        var that = this;
        var elemClass = '.' + 'zxx-clipboard';
        $('body').on('click', elemClass, function (e) {
            var text = $(this).attr('clipboard-content');
            if (text && (text + '').trim() != '') {
                proxy.clipboard.writeText(text);//第二参数 type: 在 X Window 系统上, 有一个可选的 clipboard. 你可以为每个方法使用 selection 来控制它. 无法跨平台, 不建议使用.
                console.debug('成功复制数据到剪贴板');
                console.debug(text);

                e.preventDefault();
                e.stopPropagation();
                return false;//防止冒泡.
            } else {
                var ccElem = $(this).find('[zxx-for="clipboard-content"]');
                if (ccElem.length > 0) {
                    if (ccElem.attr('clipboard-writetype') == 'html') {
                        proxy.clipboard.writeHtml(ccElem.html());
                        console.debug('成功复制数据到剪贴板');
                        console.debug($(ccElem.html()));
                    } else {
                        proxy.clipboard.writeText(that.removeHtml(ccElem.html()));
                        console.debug('成功复制数据到剪贴板');
                        console.debug(that.removeHtml(ccElem.html()));
                    }

                    e.preventDefault();
                    e.stopPropagation();
                    return false;//防止冒泡.
                }
            }
        });
        return this;
    };

    /**
     * 右键上下文菜单自动配置
     */
    this.configMenu = function () {
        var that = this;
        var elemClass = '.' + 'zxx-menu-listener';
        $('body').on('mousedown', elemClass, function (e) {
            e = e || window.event;
            if (3 === e.which) {
                //右键单击
                var elem = $(e.target);
                if (!elem.attr('zxx-menu')) {
                    elem = elem.parents('[zxx-menu]');
                }
                var menuKey = elem.attr('zxx-menu');
                console.debug('右键菜单: ' + menuKey);
                var mItems = eval('autoContextMenu.' + menuKey)(elem);
                console.debug(mItems);
                proxy.popupMenu(mItems);
                // e.stopPropagation();
            } else if (1 === e.which) {
                //左键单击
            }
        });
        return this;
    };

    /**
     * 设定一个方法, 锁定a的链接跳转, 转为系统默认浏览器打开, 而不是新建客户端窗口打开.
     * @private
     */
    this.lockAHref = function () {
        $("a[href^='http']").attr({'target': '_blank'}).attr('openExternal', 'true');
        return this;
    }

};
var $$ = new ZXX();

$(function () {
    $$.dealIframeSrc().configMenu();

    var body = $('body');
    body.on("click", "a[href^='http']", function () {
        $$.lockAHref();
        var url = $(this).attr('href');
        proxy.openExternal(url);
        return false;//阻止href动作.
    });
});

$(window).ready(function () {
    setTimeout(() => {
        $$.animateIn().animateStay().animateOut().writeClipboard();
    }, 1000);
});

